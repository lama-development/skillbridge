<!DOCTYPE html>
<html lang="it" class="h-100">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - SkillBridge</title>
    <%- include('partials/head') %>
    <script src="/js/scripts.js" defer></script>
</head>

<body class="d-flex flex-column h-100 has-navbar-padding">
    
    <%- include('partials/navbar') %>
    <%- include('partials/modal') %>
    
    <!-- Main content -->
    <main class="flex-shrink-0">
        <div class="container py-4">
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div class="row g-0 chat-height">
                        <!-- Lista contatti -->
                        <div class="col-md-4 chat-sidebar">
                            <div class="p-3 border-bottom">
                                <h5 class="mb-0 fw-bold">Messaggi</h5>
                            </div>
                            <div class="chat-contacts">
                                <% if (conversations && conversations.length > 0) { %>
                                    <% conversations.forEach(conversation => { %>
                                        <div class="chat-contact p-3 <%= selectedConversation && selectedConversation.id === conversation.id ? 'active' : '' %>">
                                            <a href="/chat/<%= conversation.otherUser %>" class="text-decoration-none text-dark">
                                                <div class="d-flex align-items-center">
                                                    <div class="me-3">
                                                        <img src="<%= conversation.profilePicture || (conversation.type === 'business' ? '/img/business.png' : '/img/freelancer.png') %>" alt="Profile" class="rounded-circle profile-img-small">
                                                    </div>
                                                    <div class="flex-grow-1">
                                                        <h6 class="mb-0 fw-bold">
                                                            <%= conversation.name %>
                                                        </h6>
                                                        <p class="mb-0 small text-truncate text-muted">@<%= conversation.otherUser %></p>
                                                    </div>
                                                </div>
                                            </a>
                                        </div>
                                    <% }) %>
                                <% } else { %>
                                    <div class="p-3 text-center text-muted">
                                        <p class="mb-0">Ancora nessuna conversazione</p>
                                        <small>Inizia una conversazione da un profilo o da un post.</small>
                                    </div>
                                <% } %>
                            </div>
                        </div>
                        <!-- Area conversazione -->
                        <div class="col-md-8 d-flex flex-column">
                            <% if (selectedConversation && otherUser) { %>
                                <!-- Header conversazione -->
                                <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <a href="/profile/<%= otherUser.username %>" class="text-decoration-none text-dark d-flex align-items-center">
                                            <div class="me-3">
                                                <img src="<%= otherUser.profilePicture || (otherUser.type === 'business' ? '/img/business.png' : '/img/freelancer.png') %>" 
                                                    alt="Profile" class="rounded-circle profile-img-small">
                                            </div>
                                            <div>
                                                <h6 class="mb-0 fw-bold">
                                                    <%= otherUser.name %>
                                                </h6>
                                                <small class="text-muted">@<%= otherUser.username %></small>
                                            </div>
                                        </a>
                                    </div>
                                </div>
                                <!-- Messaggi -->
                                <div class="chat-messages p-3 d-flex flex-column" id="chat-messages">
                                    <% if (messages && messages.length > 0) { %>
                                        <% messages.forEach(message => { %>
                                            <div class="message <%= message.sender === user.username ? 'message-sent' : 'message-received' %>">
                                                <div class="message-content"><%= message.content %></div>
                                                <!-- <small class="text-muted message-time" data-timestamp="<%= message.createdAt %>">
                                                    <%= new Date(message.createdAt).toLocaleString('it-IT') %>
                                                </small> -->
                                            </div>
                                        <% }) %>
                                    <% } else { %>
                                        <div class="text-center text-muted mt-4">
                                            <p>Ancora nessun messaggio. Inizia la conversazione!</p>
                                        </div>
                                    <% } %>
                                </div>
                                <!-- Input messaggi -->
                                <div class="chat-input mt-auto">
                                    <form action="/chat/<%= otherUser.username %>/send" method="POST" class="d-flex align-items-center p-3">
                                        <input type="text" name="message" class="form-control me-2" placeholder="Scrivi un messaggio..." maxlength="1000" autocomplete="off" required>
                                        <button type="submit" class="btn btn-primary d-flex align-items-center justify-content-center" style="width: 45px; height: 38px;">
                                            <i class="bi bi-send-fill"></i>
                                        </button>
                                    </form>
                                </div>
                            <% } else { %>
                                <!-- Nessuna conversazione selezionata -->
                                <div class="d-flex flex-column justify-content-center align-items-center h-100 text-muted">
                                    <i class="bi bi-chat-dots-fill fs-1 mb-3"></i>
                                    <h5>Seleziona una conversazione</h5>
                                    <p class="text-center">Scegli una conversazione dalla lista a sinistra<br>o iniziane una nuova da un profilo utente.</p>
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <%- include('partials/footer') %>

</body>

</html>